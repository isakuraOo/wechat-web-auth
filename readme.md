# 微信网页授权中心


「微信网页授权中心」（后统一称本系统）是一个授权分发中心系统。受限于目前微信服务号的网页授权域名只能绑定一个，当你只有一个认证服务号却有多个域名下的系统希望可以获得微信网页授权时；或者是你没有认证服务号，但是你的基友有。或许你可以考虑一下使用我的授权中心。

## 说明

本系统是基于优雅且高效的 Lumen 框架实现的。通过 系统存储的白名单数据 + 访问签名验证 的方式对允许的外部系统向本系统发起授权申请。微信授权成功后拿到的 code 数据从 redirect_url 回调地址返回给外部系统，外部系统再通过 code 去进行授权后的业务操作。对于你的系统来说，就像直接调用微信网页授权一样类似的操作即可。
「目前需要外部系统与本系统使用相同的 AppID & secret」

## 开发

项目拉取后，首先跟正常 Lumen 代码处理一样，你需要先 `composer update` 将 Lumen 的核心文件准备好。接着你需要将 `.env.example` 文件拷贝一份到 `.env` 根据你的环境情况配置一下里面的内容。
在 `/database/` 下有 `wx_auth.sql` 数据库文件，你可以利用它创建数据库，它将被用于存放白名单的相关数据。目前没有提供接口去新增白名单数据，你可以自己动手插入白名单数据。

## 接入
接入授权中心，首先你需要在授权中心的白名单中。在向授权中心发起授权申请的时候，你需要提供以下几个参数
`system`,`timestamp`,`nonce`,`signature`,`redirect_url`
他们分别是

- `system`: 系统标识「与授权中心白名单存储数据一致」
- `timestamp`: 时间戳
- `nonce`: 随机字符串
- `signature`: 签名密文「加密规则见下文」
- `redirect_url`: 授权成功后的回调地址

授权成功后，授权中心将在 `redirect_url` 的后面带上微信回调中拿到的 `code` 参数。你可以使用 `code` 去向微信索要用户的 `access_token` 访问令牌「这里可能需要你拥有与授权中心使用服务号一致的 `AppId`,`secret` 两个参数」

## 签名加密

签名需要用到 `system`,`token`,`timestamp`,`nonce` 四个参数，其中 `token` 需要与授权中心白名单中的设置的 `token` 一致。
对四个参数进行字典序排序后组合成字符串，然后对字符串进行 `sha1` 加密生成 `signature`